!function(e){var t={};function i(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(a,s,function(t){return e[t]}.bind(null,s));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/build/plugins/",i(i.s=13)}([function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e,t,i){this.relativeOriginX=e,this.relativeOriginY=t,this.pageIndex=i}getCoordsInPage(e){let t=Math.pow(2,e);return{x:this.relativeOriginX*t,y:this.relativeOriginY*t}}getCoordsInViewport(e,t,i){const a=Math.max(0,(i._viewport.width-i.layout.dimensions.width)/2),s=Math.max(0,(i._viewport.height-i.layout.dimensions.height)/2);let r=this.getCoordsInPage(e);return{x:i._getImageOffset(t).left-i._viewport.left+a+r.x,y:i._getImageOffset(t).top-i._viewport.top+s+r.y}}getAbsoluteCoordinatesFromPadded(e,t,i,a){const s=Math.max(0,(t._viewport.width-t.layout.dimensions.width)/2),r=Math.max(0,(t._viewport.height-t.layout.dimensions.height)/2);return{x:Math.round(i-(t._getImageOffset(e).left-t._viewport.left+s)),y:Math.round(a-(t._getImageOffset(e).top-t._viewport.top+r))}}getPaddedCoordinatesFromAbsolute(e,t,i,a){const s=Math.max(0,(t._viewport.width-t.layout.dimensions.width)/2),r=Math.max(0,(t._viewport.height-t.layout.dimensions.height)/2);return{x:t._getImageOffset(e).left-t._viewport.left+s+i,y:t._getImageOffset(e).top-t._viewport.top+r+a}}getRelativeCoordinatesFromPadded(e,t,i,a,s){let r=Math.pow(2,s);const n=Math.max(0,(t._viewport.width-t.layout.dimensions.width)/2),o=Math.max(0,(t._viewport.height-t.layout.dimensions.height)/2);return{x:(i-t._getImageOffset(e).left+t._viewport.left-n)/r,y:(a-t._getImageOffset(e).top+t._viewport.top-o)/r}}}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e,t,i,a){this.red=e,this.green=t,this.blue=i,this.alpha=a}toHTMLColour(){return"rgba("+this.red+", "+this.green+", "+this.blue+", "+this.alpha+")"}toHexString(){let e="#",t=this.red.toString(16),i=this.green.toString(16),a=this.blue.toString(16);return 1===t.length&&(e=e.concat("0")),e=e.concat(t),1===i.length&&(e=e.concat("0")),e=e.concat(i),1===a.length&&(e=e.concat("0")),e=e.concat(a)}isSimilarTo(e,t){return e.red>=this.red-t&&e.red<=this.red+t&&(e.blue>=this.blue-t&&e.blue<=this.blue+t&&(e.green>=this.green-t&&e.green<=this.green+t))}}},function(e,t,i){"use strict";i.d(t,"a",function(){return s}),i.d(t,"b",function(){return r});class a{constructor(e){this.message=e}}class s extends a{}class r extends a{}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e){this.pixelInstance=e,this.currentTutorialPageIndex=0,this.modalContent=document.createElement("div"),this.createTutorial()}createTutorial(){let e=document.createElement("div");e.setAttribute("id","tutorial-div");let t=document.createElement("div");t.setAttribute("id","tutorial-overlay");let i=document.createElement("div");i.setAttribute("id","myModal"),i.setAttribute("class","modal"),this.modalContent.setAttribute("class","modal-content");let a=document.createElement("div");a.setAttribute("class","modal-header");let s=document.createTextNode("Tutorial"),r=document.createElement("h2");r.appendChild(s);let n=document.createElement("span");n.setAttribute("class","close"),n.innerHTML="&times;";let o=this.getModalBody(this.currentTutorialPageIndex),l=document.createElement("div");l.setAttribute("class","modal-footer"),l.setAttribute("id","modal-footer");let d=document.createElement("h2");d.innerHTML="Got It!",i.appendChild(this.modalContent),this.modalContent.appendChild(a),this.modalContent.appendChild(o),this.modalContent.appendChild(l),a.appendChild(r),a.appendChild(n),l.appendChild(d),e.appendChild(t),e.appendChild(i),document.body.appendChild(e),i.style.display="block",l.addEventListener("click",()=>{e.parentNode.removeChild(e)})}getModalBody(e){let t=document.createElement("div");t.setAttribute("class","modal-body"),t.setAttribute("id","modal-body");let i=document.createElement("p"),a=new Image;a.className="tutorial-image";let s=document.createElement("button");s.innerHTML="Next";let r=document.createElement("button");r.innerHTML="Previous";let n=document.createElement("p");switch(n.setAttribute("id","tutorial-progress"),n.innerHTML=e+1+"/16",s.addEventListener("click",()=>{this.currentTutorialPageIndex++,this.getTutorialPage(this.currentTutorialPageIndex)}),r.addEventListener("click",()=>{this.currentTutorialPageIndex--,this.getTutorialPage(this.currentTutorialPageIndex)}),e){case 0:i.innerHTML='Welcome to Pixel.js, this is a tutorial that serves as a reminder of the available tools. <br>For a complete, detailed tutorial, visit the <a href="https://github.com/DDMAL/Pixel.js/wiki/How-to-use-Pixel.js">Full Tutorial Page</a> (right-click -> Open Link in New Tab). <br><br>Click on Got It! to exit this tutorial.',a.src="https://media.giphy.com/media/aL9oQ0f1sDIpq/giphy.gif";break;case 1:i.innerHTML="Each layer has its own specific colour and represents a classification category. Create as many layers as needed. <br> A collection of keyboard shortcuts have been implemented. Each layer can be selected by its number (from <kbd>1</kbd> to <kbd>9</kbd>). Hover over the layers to receive a prompt.",a.src="https://media.giphy.com/media/rBiuWy5YUsIow/giphy.gif";break;case 2:i.innerHTML="You can upload images to the currently selected layer. The image will be converted to the specified layer's colour. <br> In this example, we have uploaded the output images of a classification method in order to correct it.",a.src="https://media.giphy.com/media/Qy4u6oHru8OpG/giphy.gif";break;case 3:i.innerHTML="Double click on the layer's name to rename it.",a.src="https://media.giphy.com/media/LRxzQa1ogqKAw/giphy.gif";break;case 4:i.innerHTML="Use zoom along with the grab tool <kbd>g</kbd> to navigate a page.",a.src="https://media.giphy.com/media/hcLjZ9dFHOKDm/giphy.gif";break;case 5:i.innerHTML="Use the select tool <kbd>s</kbd> to copy <kbd>Ctrl</kbd> + <kbd>c</kbd> or cut <kbd>Ctrl</kbd> + <kbd>x</kbd> and paste <kbd>Ctrl</kbd> + <kbd>v</kbd> rectangular regions of pixels from one layer to another.",a.src="https://media.giphy.com/media/ruMD98axGjdyE/giphy.gif";break;case 6:i.innerHTML="Right-click and drag right and left on the erase <kbd>e</kbd> and brush <kbd>b</kbd> tools to change the brush size.",a.src="https://media.giphy.com/media/NhvALG9MhGYta/giphy.gif";break;case 7:i.innerHTML="Press <kbd>Shift</kbd> and drag on the erase <kbd>e</kbd> and brush <kbd>b</kbd> tools to draw straight lines.",a.src="https://media.giphy.com/media/t74TeR1gd9aaA/giphy.gif";break;case 8:i.innerHTML="Right-click and drag on rectangle tool <kbd>r</kbd> to erase rectangular regions, left-click to draw rectangle. Press <kbd>Shift</kbd> to draw squares.",a.src="https://media.giphy.com/media/i497rUNYB8t32/giphy.gif";break;case 9:i.innerHTML="Use the Fullscreen mode <kbd>f</kbd> and the browser zoom to get more precision, when needed. <br> To exit Fullscreen mode, press on <kbd>f</kbd> again.",a.src="https://media.giphy.com/media/FkzOAenUJxfGg/giphy.gif";break;case 10:i.innerHTML="You can bring a layer forward/backward by clicking and dragging them to their desired position.<br>You can also use <kbd>[</kbd> and <kbd>]</kbd> to move a selected layer down or up.",a.src="https://media.giphy.com/media/DImPhyGZ3OltC/giphy.gif";break;case 11:i.innerHTML="You can undo <kbd>Ctrl</kbd> + <kbd>z</kbd> and redo <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>z</kbd> an action.",a.src="https://media.giphy.com/media/24kHpWLzbHFrq/giphy.gif";break;case 12:i.innerHTML="You can delete a layer by selecting it and then using <kbd>Ctrl</kbd> + <kbd>del</kbd>.",a.src="https://media.giphy.com/media/cmQesBkeEvdmM/giphy.gif";break;case 13:i.innerHTML="You can mute (press <kbd>m</kbd> to toggle on/off) or hide (hold <kbd>h</kbd> to turn off, release to turn on) layers.",a.src="https://media.giphy.com/media/BhVXr7ONVdStq/giphy.gif";break;case 14:i.innerHTML="Change the opacity of a layer by displaying the layer options.",a.src="https://media.giphy.com/media/94EtnDoG2yNAQ/giphy.gif";break;case 15:i.innerHTML='Export layers as PNGs to save a specific layer as an image. See the <a href="https://github.com/DDMAL/Pixel.js/wiki">wiki</a> for details on the different export buttons and more information.',a.src="https://media.giphy.com/media/kBAau6Gebio7e/giphy.gif"}return t.appendChild(a),t.appendChild(i),0!==this.currentTutorialPageIndex&&t.appendChild(r),15!==this.currentTutorialPageIndex&&t.appendChild(s),t.appendChild(n),t}getTutorialPage(e){let t=document.getElementById("modal-body");t.parentElement.removeChild(t),this.modalContent.insertBefore(this.getModalBody(e),document.getElementById("modal-footer"))}}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e){this.pixelInstance=e,this.currentTutorialPageIndex=0,this.modalContent=document.createElement("div"),this.createGlossary()}createGlossary(){let e=document.createElement("div");e.setAttribute("id","glossary-div");let t=document.createElement("div");t.setAttribute("id","glossary-overlay");let i=document.createElement("div");i.setAttribute("id","myModal"),i.setAttribute("class","modal"),this.modalContent.setAttribute("class","modal-content");let a=document.createElement("div");a.setAttribute("class","modal-header");let s=document.createTextNode("Keyboard Shortcuts"),r=document.createElement("h2");r.appendChild(s);let n=document.createElement("span");n.setAttribute("class","close"),n.innerHTML="&times;";let o=this.getModalBody(this.currentTutorialPageIndex),l=document.createElement("div");l.setAttribute("class","modal-footer"),l.setAttribute("id","modal-footer");let d=document.createElement("h2");d.innerHTML="Got It!",i.appendChild(this.modalContent),this.modalContent.appendChild(a),this.modalContent.appendChild(o),this.modalContent.appendChild(l),a.appendChild(r),a.appendChild(n),l.appendChild(d),e.appendChild(t),e.appendChild(i),document.body.appendChild(e),i.style.display="block",l.addEventListener("click",()=>{e.parentNode.removeChild(e)})}getModalBody(){let e=document.createElement("div");e.setAttribute("class","modal-body"),e.setAttribute("id","modal-body");let t=document.createElement("p");t.innerHTML='The following is a glossary of available hotkeys. To learn how to use them in more detail, please consult the Pixel.js <a href="https://github.com/DDMAL/Pixel.js/wiki">wiki</a> for details on the different export buttons and more information.';let i=document.createElement("ul");i.setAttribute("style","list-style-type:none;");let a=document.createElement("li");a.innerHTML="<kbd>1</kbd> ... <kbd>9</kbd> layer select";let s=document.createElement("li");s.innerHTML="<kbd>B</kbd> brush tool";let r=document.createElement("li");r.innerHTML="<kbd>E</kbd> eraser tool";let n=document.createElement("li");n.innerHTML="<kbd>F</kbd> full screen mode";let o=document.createElement("li");o.innerHTML="<kbd>G</kbd> grab tool";let l=document.createElement("li");l.innerHTML="<kbd>H</kbd> hide selected layer (hold down)";let d=document.createElement("li");d.innerHTML="<kbd>K</kbd> keyboard shortcut list";let c=document.createElement("li");c.innerHTML="<kbd>M</kbd> mute selected layer";let h=document.createElement("li");h.innerHTML="<kbd>R</kbd> rectangle tool";let u=document.createElement("li");u.innerHTML="<kbd>T</kbd> tutorial";let g=document.createElement("li");g.innerHTML="<kbd>ctrl</kbd> + <kbd>N</kbd> create new layer";let p=document.createElement("li");p.innerHTML="<kbd>cmd</kbd>/<kbd>ctrl</kbd> + <kbd>backspace</kbd> delete selected layer";let m=document.createElement("li");m.innerHTML="<kbd>cmd</kbd>/<kbd>ctrl</kbd> + <kbd>Z</kbd> undo";let y=document.createElement("li");y.innerHTML="<kbd>cmd</kbd>/<kbd>ctrl</kbd> + <kbd>Shift</kbd> + <kbd>Z</kbd> redo";let b=document.createElement("li");b.innerHTML="<kbd>[</kbd> move selected layer down";let v=document.createElement("li");v.innerHTML="<kbd>]</kbd> move selected layer up";let x=document.createElement("li");return x.innerHTML="<kbd>Shift</kbd> force tools to paint in an exact way",i.appendChild(a),i.appendChild(s),i.appendChild(r),i.appendChild(n),i.appendChild(o),i.appendChild(l),i.appendChild(d),i.appendChild(c),i.appendChild(h),i.appendChild(u),i.appendChild(g),i.appendChild(p),i.appendChild(m),i.appendChild(y),i.appendChild(b),i.appendChild(v),i.appendChild(x),e.appendChild(t),e.appendChild(i),e}getTutorialPage(e){let t=document.getElementById("modal-body");t.parentElement.removeChild(t),this.modalContent.insertBefore(this.getModalBody(e),document.getElementById("modal-footer"))}}},function(e,t,i){"use strict";i.d(t,"a",function(){return r});var a=i(1),s=i(0);class r{constructor(e,t,i,a,s){this.pixelInstance=e,this.layers=t,this.exportLayersCount=t.length,this.interrupted=!1,this.dataCanvases=[],this.pageIndex=i,this.zoomLevel=a,this.matrix=null,this.uiManager=s}exportLayersAsImageData(){this.dataCanvases=[];let e=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).height,t=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).width,i=this.uiManager.createExportElements(this).progressCanvas;this.layers.forEach(a=>{let s=document.createElement("canvas");s.setAttribute("class","export-page-canvas"),s.setAttribute("id","layer-"+a.layerId+"-export-canvas"),s.setAttribute("style","position: absolute; top: 0; left: 0;"),s.width=t,s.height=e,a.drawLayerInPageCoords(this.zoomLevel,s,this.pageIndex);let r=document.createElement("canvas");r.setAttribute("class","export-page-data-canvas"),r.setAttribute("id","layer-"+a.layerId+"-export-canvas"),r.setAttribute("value",a.layerName),r.setAttribute("style","position: absolute; top: 0; left: 0;"),r.width=t,r.height=e,this.dataCanvases.push(r),this.getImageData(this.pixelInstance.core.getSettings().renderer._canvas,r,this.pageIndex,s,i)})}exportLayersAsCSV(){let e=this.pixelInstance.core,t=e.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).height,i=e.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).width,a=this.uiManager.createExportElements(this).progressCanvas;this.initializeMatrix(),this.exportLayersCount=this.layers.length,this.layers.forEach(e=>{let s=document.createElement("canvas");s.setAttribute("class","export-page-canvas"),s.setAttribute("id","layer-"+e.layerId+"-export-canvas"),s.width=i,s.height=t,e.drawLayerInPageCoords(this.zoomLevel,s,this.pageIndex),this.fillMatrix(e,this.matrix,s,a)})}exportLayersAsPNG(){let e=document.getElementById("png-links-div");null!==e&&e.parentElement.removeChild(e),(e=document.createElement("div")).setAttribute("id","png-links-div"),this.layers.forEach(t=>{t.getCanvas().toBlob(i=>{let a=document.createTextNode("Download "+t.layerName+" PNG "),s=document.getElementById(t.layerName+"-png-download");if(null===s){let t=document.createElement("img"),r=URL.createObjectURL(i);t.src=r,(s=document.createElement("a")).appendChild(a),e.appendChild(s)}let r=URL.createObjectURL(i);s.setAttribute("class","export-download"),s.setAttribute("id",t.layerName+"-png-download"),s.setAttribute("href",r),s.setAttribute("download",t.layerName)})}),document.body.appendChild(e)}getImageData(e,t,i,s,r){let n=s.width,o=0,l=0,d=0,c=s.getContext("2d"),h=this.pixelInstance.core.getSettings().renderer,u=()=>{let g=n;for(o++;g--&&!(l>=s.height);)if(d<s.width){let s=c.getImageData(d,l,1,1).data;0!==new a.a(s[0],s[1],s[2],s[3]).alpha&&this.drawImageDataOnCanvas(l,d,i,h,e,t,r),d++}else l++,d=0;this.postProcessImageDataIteration(l,t,o,n,s).needsRecall&&setTimeout(u,1)};u()}drawImageDataOnCanvas(e,t,i,r,n,o,l){let d=o.getContext("2d"),c=n.getContext("2d"),h=l.getContext("2d"),u=(new s.a).getPaddedCoordinatesFromAbsolute(i,r,t,e);u.y<0?r.goto(i,e,t):u.y>n.height?r.goto(i,e+n.height,t):u.x<0?r.goto(i,e,t):u.x>n.width&&r.goto(i,e,t+n.width);let g=c.getImageData(u.x,u.y,1,1).data,p=new a.a(g[0],g[1],g[2],g[3]);d.fillStyle=p.toHTMLColour(),d.fillRect(t,e,1,1),h.fillStyle=p.toHTMLColour(),h.fillRect(t,e,1,1)}postProcessImageDataIteration(e,t,i,a,s){if((e===s.height||this.exportInterrupted)&&(this.exportLayersCount-=1),e<s.height&&!this.exportInterrupted){let e=i*a*100/(s.height*s.width),t=e>100?100:Math.round(10*e)/10;return this.pixelInstance.uiManager.updateProgress(t),{needsRecall:!0}}return this.exportInterrupted&&0===this.exportLayersCount?(this.exportInterrupted=!1,this.uiManager.destroyExportElements()):this.exportInterrupted||(t.toBlob(e=>{let i=document.createTextNode("Download "+t.getAttribute("value")+" image data "),a=document.getElementById(t.getAttribute("value")+"-image-data-download");if(null===a){let t=document.createElement("img"),s=URL.createObjectURL(e);t.src=s,(a=document.createElement("a")).appendChild(i),document.body.appendChild(a)}let s=URL.createObjectURL(e);a.setAttribute("class","export-download"),a.setAttribute("id",t.getAttribute("value")+"-image-data-download"),a.setAttribute("href",s),a.setAttribute("download",t.getAttribute("value")+" image data")}),0===this.exportLayersCount&&this.uiManager.destroyExportElements()),{needsRecall:!1}}fillMatrix(e,t,i,a){let s=i.width,r=3,n=a.getContext("2d"),o=i.getContext("2d").getImageData(0,0,i.width,i.height).data,l=()=>{let a=s;for(0;a--&&!(r>o.length);){if(0!==o[r]){let a=Math.floor(r/4),s=parseInt(a/i.height),o=parseInt(a%i.width);t[s][o]=e.layerId,n.fillStyle=e.colour.toHTMLColour(),n.fillRect(o,s,1,1)}r+=4}if(r>=o.length||this.exportInterrupted)this.exportLayersCount-=1;else{let e=r/o.length*100,t=e>100?100:Math.round(10*e)/10;this.pixelInstance.uiManager.updateProgress(t),setTimeout(l,1)}0===this.exportLayersCount&&(this.uiManager.destroyExportElements(),this.exportInterrupted?this.exportInterrupted=!1:this.transformMatrixToCSV())};l()}initializeMatrix(){let e=this.pixelInstance.core,t=e.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).height,i=e.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,this.zoomLevel).width;this.matrix=new Array(t).fill(null).map(()=>new Array(i).fill(0))}transformMatrixToCSV(){let e="";for(var t=0;t<this.matrix.length;t++){e+=this.matrix[t].join(","),e+="\n"}let i=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(i,"pixel-export");else{let e=document.createTextNode("Download CSV "),t=document.getElementById("csv-download");null===t&&((t=document.createElement("a")).appendChild(e),document.body.appendChild(t));let a=URL.createObjectURL(i);t.setAttribute("class","export-download"),t.setAttribute("id","csv-download"),t.setAttribute("href",a),t.setAttribute("download","pixel-export")}}printMatrixOnCanvas(e){let t=this.matrix[0].length,i=e.getContext("2d"),a=(e,t)=>{this.layers.forEach(a=>{a.layerId===this.matrix[e][t]&&(i.fillStyle=a.colour.toHTMLColour(),i.fillRect(t,e,1,1))})};for(var s=0;s<this.matrix.length;s++)for(var r=0;r<t;r++)0!==this.matrix[s][r]&&a(s,r)}}},function(e,t,i){"use strict";class a{constructor(e,t){this.points=[],this.brushSize=e,this.type="path",this.blendMode=t,this.lastAbsX=0,this.lastAbsY=0}addPointToPath(e){this.points.push(e)}drawInViewport(e,t,i,a,s){let r=!1;this.points.forEach(n=>{this.connectPoint(e,n,t,i,r,a,s,"viewport"),r=!0})}drawOnPage(e,t,i,a,s){let r=!1;this.points.forEach(n=>{this.connectPoint(e,n,t,i,r,a,s,"page"),r=!0})}connectPoint(e,t,i,a,s,r,n,o){let l,d=Math.pow(2,a),c=n.getContext("2d");if(i!==t.pageIndex)return;switch(o){case"viewport":l=t.getCoordsInViewport(a,i,r);break;case"page":l=t.getCoordsInPage(a);break;default:l=t.getCoordsInViewport(a,i,r)}let h=l.x,u=l.y;s&&("add"===this.blendMode?(c.globalCompositeOperation="source-over",c.beginPath(),c.strokeStyle=e.colour.toHTMLColour(),c.lineWidth=this.brushSize*d,c.lineJoin="round",c.moveTo(this.lastAbsX,this.lastAbsY),c.lineTo(h,u),c.closePath(),c.stroke()):"subtract"===this.blendMode&&(c.globalCompositeOperation="destination-out",c.beginPath(),c.strokeStyle="rgba(250,250,250,1)",c.lineWidth=this.brushSize*d,c.lineJoin="round",c.moveTo(this.lastAbsX,this.lastAbsY),c.lineTo(h,u),c.closePath(),c.stroke()),c.globalCompositeOperation="source-over"),this.lastAbsX=h,this.lastAbsY=u}}var s=i(0);class r{constructor(e,t){this.object=e,this.layer=t}}i.d(t,"a",function(){return n});class n{constructor(e,t,i,a,s){this.layerId=e,this.shapes=[],this.paths=[],this.colour=t,this.layerName=i,this.canvas=null,this.ctx=null,this.actions=[],this.activated=!0,this.layerOpacity=s,this.pixelInstance=a,this.pageIndex=this.pixelInstance.core.getSettings().activePageIndex,this.backgroundImageCanvas=null,this.pastedRegions=[],this.cloneCanvas()}cloneCanvas(){let e=this.pixelInstance.core.getSettings().maxZoomLevel,t=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,e).height,i=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,e).width;this.canvas=document.createElement("canvas"),this.canvas.setAttribute("class","pixel-canvas"),this.canvas.setAttribute("id","layer-"+this.layerId+"-canvas"),this.canvas.width=i,this.canvas.height=t,this.ctx=this.canvas.getContext("2d"),this.resizeLayerCanvasToZoomLevel(this.pixelInstance.core.getSettings().zoomLevel),this.placeLayerCanvasOnTopOfEditingPage(),this.backgroundImageCanvas=document.createElement("canvas"),this.backgroundImageCanvas.width=this.canvas.width,this.backgroundImageCanvas.height=this.canvas.height}resizeLayerCanvasToZoomLevel(e){let t=Math.floor(e),i=e-t,a=Math.pow(2,i),s=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,t).height,r=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(this.pageIndex,t).width;r*=a,s*=a,this.canvas.style.width=r+"px",this.canvas.style.height=s+"px",this.placeLayerCanvasOnTopOfEditingPage(),null!==this.pixelInstance.uiManager&&this.pixelInstance.uiManager.resizeBrushCursor()}placeLayerCanvasOnTopOfEditingPage(){let e=this.pixelInstance.core.getSettings().zoomLevel,t=new s.a(0,0,0).getCoordsInViewport(e,this.pageIndex,this.pixelInstance.core.getSettings().renderer);this.canvas.style.left=t.x+"px",this.canvas.style.top=t.y+"px"}placeCanvasAfterElement(e){e.parentNode.insertBefore(this.canvas,e.nextSibling)}getCanvas(){return this.canvas}getCtx(){return this.ctx}clearCtx(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateLayerName(e){this.layerName=e}addShapeToLayer(e){this.shapes.push(e),this.addAction(new r(e,this))}addPathToLayer(e){this.paths.push(e),this.addAction(new r(e,this))}addToCurrentPath(e,t){0===this.paths.length&&this.createNewPath(this.pixelInstance.uiManager.getBrushSizeSelectorValue(),t),this.paths[this.paths.length-1].addPointToPath(e)}getCurrentPath(){return this.paths.length>0?this.paths[this.paths.length-1]:null}createNewPath(e,t){let i=new a(e,t);this.paths.push(i),this.addAction(new r(i,this))}removePathFromLayer(e){let t=this.paths.indexOf(e);this.paths.splice(t,1),this.actions.forEach(t=>{t.object===e&&this.removeAction(t)})}removeShapeFromLayer(e){let t=this.shapes.indexOf(e);this.shapes.splice(t,1),this.actions.forEach(t=>{t.object===e&&this.removeAction(t)})}removeSelectionFromLayer(e){let t=this.pastedRegions.indexOf(e);this.pastedRegions.splice(t,1),this.actions.forEach(t=>{t.object===e&&this.removeAction(t)})}setOpacity(e){this.colour.alpha=e}getOpacity(){return this.colour.alpha}getCurrentShape(){return this.shapes.length>0?this.shapes[this.shapes.length-1]:null}isActivated(){return this.activated}setLayerOpacity(e){this.layerOpacity=e}getLayerOpacity(){return this.layerOpacity}getLayerOpacityCSSString(){return"opacity : "+this.layerOpacity}drawLayer(e,t){this.isActivated()&&this.drawLayerInPageCoords(e,t,this.pageIndex)}drawLayerInPageCoords(e,t,i){let a=t.getContext("2d");a.clearRect(0,0,t.width,t.height),null!==this.backgroundImageCanvas&&a.drawImage(this.backgroundImageCanvas,0,0),this.actions.forEach(a=>{a.object.drawOnPage(this,i,e,this.pixelInstance.core.getSettings().renderer,t)})}setBackgroundImageCanvas(e){this.backgroundImageCanvas=e}addToPastedRegions(e){this.pastedRegions.push(e),this.addAction(new r(e,this))}addAction(e){this.actions.push(e),"selection"===e.object.type&&"select"===e.object.selectedShape.blendMode||this.pixelInstance.actions.push(e)}removeAction(e){let t=this.actions.indexOf(e);this.actions.splice(t,1);let i=this.pixelInstance.actions.indexOf(e);this.pixelInstance.actions.splice(i,1)}displayColourOptions(){console.log("colour clicked here")}displayLayerOptions(){let e=document.getElementById("layer-"+this.layerId+"-options");e.classList.contains("unchecked-layer-settings")?(e.classList.remove("unchecked-layer-settings"),e.classList.add("checked-layer-settings"),this.pixelInstance.uiManager.createOpacitySlider(this,e.parentElement.parentElement,e.parentElement)):(e.classList.remove("checked-layer-settings"),e.classList.add("unchecked-layer-settings"),this.pixelInstance.uiManager.destroyOpacitySlider(this))}activateLayer(){let e=document.getElementById("layer-"+this.layerId+"-activation");e.classList.remove("layer-deactivated"),e.classList.add("layer-activated"),this.getCanvas().style.opacity=this.getLayerOpacity(),this.layerId===this.pixelInstance.background.layerId?this.activated=!0:(this.activated=!0,this.pixelInstance.redrawLayer(this))}deactivateLayer(){let e=document.getElementById("layer-"+this.layerId+"-activation");e.classList.remove("layer-activated"),e.classList.add("layer-deactivated"),this.activated=!1,this.layerId===this.pixelInstance.background.layerId?this.getCanvas().style.opacity=0:this.clearCtx()}toggleLayerActivation(){document.getElementById("layer-"+this.layerId+"-activation").classList.contains("layer-deactivated")?this.activateLayer():this.deactivateLayer()}}},function(e,t,i){"use strict";var a=i(0),s=i(1);class r{constructor(e,t){this.origin=e,this.type="shape",this.blendMode=t}drawInViewport(){}drawOnPage(){}changeBlendModeTo(e){this.blendMode=e}getPixels(e,t,i,r,n,o,l,d,c){let h=n.getContext("2d"),u=o.getContext("2d");for(var g=d;g<l;g++){let e=[];for(var p=0;p<c.length;p++)for(var m=0;m<c[p].length-1;m++){let t=c[p][m].absolutePaddedX,i=c[p][m].absolutePaddedY,a=c[p][m+1].absolutePaddedX,s=c[p][m+1].absolutePaddedY,r=t+(a-t)/(s-i)*(g-i),n=Math.round(r);(i<=g&&s>g||s<=g&&i>g)&&e.push({absolutePaddedX:n,absolutePaddedY:g})}if(e.sort((e,t)=>e.absolutePaddedX-t.absolutePaddedX),!(e.length<=0))for(var y=0;y<e.length-1;y++)if(y%2==0){let i=e[y].absolutePaddedX,o=e[y+1].absolutePaddedX,l=e[y].absolutePaddedY;for(var b=i;b<o;b++){let e=(new a.a).getAbsoluteCoordinatesFromPadded(t,r,b,l);if("add"===this.blendMode){if(e.y>=0&&e.x>=0&&e.y<=n.height&&e.x<=n.width){let i=(new a.a).getPaddedCoordinatesFromAbsolute(t,r,e.x,e.y),n=u.getImageData(i.x,i.y,1,1).data,o=new s.a(n[0],n[1],n[2],n[3]);h.fillStyle=o.toHTMLColour(),h.fillRect(e.x,e.y,1,1)}}else"subtract"===this.blendMode&&h.clearRect(e.x,e.y,1,1)}}}}}i.d(t,"a",function(){return n});class n extends r{constructor(e,t,i,a){super(e,a),this.relativeRectWidth=t,this.relativeRectHeight=i}drawInViewport(e,t,i,a,s){let r=Math.pow(2,i),n=s.getContext("2d");const o=Math.max(0,(a._viewport.width-a.layout.dimensions.width)/2),l=Math.max(0,(a._viewport.height-a.layout.dimensions.height)/2);let d=this.origin.relativeOriginX*r,c=this.origin.relativeOriginY*r,h=this.relativeRectWidth*r,u=this.relativeRectHeight*r;if("select"!==this.blendMode){if("add"===this.blendMode){if(t===this.origin.pageIndex){let i=a._getImageOffset(t).left-a._viewport.left+o+d,s=a._getImageOffset(t).top-a._viewport.top+l+c;n.fillStyle=e.colour.toHTMLColour(),n.fillRect(i,s,h,u)}}else if("subtract"===this.blendMode&&t===this.origin.pageIndex){let i=a._getImageOffset(t).left-a._viewport.left+o+d,s=a._getImageOffset(t).top-a._viewport.top+l+c;n.fillStyle=e.colour.toHTMLColour(),n.clearRect(i,s,h,u)}}else if(t===this.origin.pageIndex){let e=a._getImageOffset(t).left-a._viewport.left+o+d,i=a._getImageOffset(t).top-a._viewport.top+l+c;n.fillStyle="rgba(147, 192, 255, 0.3)",n.lineWidth=1,n.strokeStyle="rgba(25, 25, 25, 1)",n.fillRect(e,i,h,u),n.strokeRect(e,i,h,u)}}drawOnPage(e,t,i,a,s){let r=Math.pow(2,i),n=s.getContext("2d"),o=this.origin.relativeOriginX*r,l=this.origin.relativeOriginY*r,d=this.relativeRectWidth*r,c=this.relativeRectHeight*r;"select"===this.blendMode?t===this.origin.pageIndex&&(n.fillStyle="rgba(147, 192, 255, 0.5)",n.lineWidth=30/r,n.strokeStyle="rgba(97, 142, 205, 1)",n.fillRect(o,l,d,c),n.strokeRect(o,l,d,c)):"add"===this.blendMode?t===this.origin.pageIndex&&-1===e.layerId?(n.fillStyle=e.colour.toHTMLColour(),n.lineWidth=1,n.strokeStyle="rgba(0, 0, 0, 1)",n.fillRect(o,l,d,c),n.strokeRect(o,l,d,c)):t===this.origin.pageIndex&&(n.fillStyle=e.colour.toHTMLColour(),n.fillRect(o,l,d,c)):"subtract"===this.blendMode&&t===this.origin.pageIndex&&(n.fillStyle=e.colour.toHTMLColour(),n.clearRect(o,l,d,c))}getPixels(e,t,i,r,n,o){let l=Math.pow(2,i),d=n.getContext("2d"),c=o.getContext("2d"),h=this.origin.relativeOriginX*l,u=this.origin.relativeOriginY*l,g=this.relativeRectWidth*l,p=this.relativeRectHeight*l;if(t===this.origin.pageIndex)for(var m=Math.round(Math.min(u,u+p));m<Math.max(u,u+p);m++)for(var y=Math.round(Math.min(h,h+g));y<Math.max(h,h+g);y++)if(m>=0&&y>=0&&m<n.height&&y<n.width)if("add"===this.blendMode){let e=(new a.a).getPaddedCoordinatesFromAbsolute(t,r,y,m),i=c.getImageData(e.x,e.y,1,1).data,n=new s.a(i[0],i[1],i[2],i[3]),o=y/l*Math.pow(2,5),h=m/l*Math.pow(2,5);d.fillStyle=n.toHTMLColour(),d.fillRect(o,h,Math.pow(2,5),Math.pow(2,5))}else"subtract"===this.blendMode&&d.clearRect(y,m,1,1)}}},function(e,t,i){"use strict";i.d(t,"a",function(){return o});var a=i(0),s=i(3),r=i(4),n=i(2);class o{constructor(e){this.pixelInstance=e,this.mouse={x:0,y:0,startX:0,startY:0}}createPluginElements(e){this.placeLayerCanvasesInDiva(e),this.createUndoButton(),this.createRedoButton(),"undefined"==typeof numberInputLayers&&(this.createDeleteLayerButton(),this.createCreateLayerButton()),this.createLayersView(e),this.createToolsView(this.pixelInstance.tools.getAllTools()),this.createExportButtons(),this.createImportButtons(),this.createInstructionButtons()}destroyPluginElements(e,t){this.destroyLayerSelectors(e),this.destroyBrushSizeSelector(),this.destroyUndoButton(),this.destroyRedoButton(),"undefined"==typeof numberInputLayers&&(this.destroyDeleteLayerButton(),this.destroyCreateLayerButton()),this.destroyExportButtons(),this.destroyImportButtons(),this.destroyPixelCanvases(e),this.destroyToolsView(this.pixelInstance.tools.getAllTools()),this.destroyLockedLayerSelectors(t),this.destroyDownloadLinks(),this.destroyBrushCursor(),this.restoreDefaultCursor(),this.destroyInstructionButtons()}createToolsView(e){let t=document.createElement("form");t.setAttribute("id","tool-selector"),t.setAttribute("class","tool-selector");let i=e=>{e.addEventListener("click",()=>{this.pixelInstance.tools.setCurrentTool(e.value)})};for(let a=0;a<e.length;a++){let s=e[a],r=document.createElement("input"),n=document.createElement("label");n.setAttribute("for",s),n.innerHTML=s,r.setAttribute("id",s),r.setAttribute("type","radio"),r.setAttribute("value",s),r.setAttribute("name","tool-selector"),r.setAttribute("class","radio-select"),i(r),t.appendChild(r),t.appendChild(n)}document.body.appendChild(t),this.pixelInstance.tools.setCurrentTool(this.pixelInstance.tools.getCurrentTool())}destroyToolsView(){let e=document.getElementById("tool-selector");e.parentNode.removeChild(e)}placeLayerCanvasesInDiva(e){let t=this.pixelInstance.core.getSettings().renderer._canvas;for(let i=e.length-1;i>=0;i--){let a=e[i];a.placeCanvasAfterElement(t),a.isActivated()?a.getCanvas().style.opacity=a.getLayerOpacity():a.getCanvas().style.opacity=0}this.pixelInstance.background.isActivated()?this.pixelInstance.background.getCanvas().style.opacity=this.pixelInstance.background.getLayerOpacity():this.pixelInstance.background.getCanvas().style.opacity=0}destroyPixelCanvases(e){e.forEach(e=>{null!==e.getCanvas().parentNode&&e.getCanvas().parentNode.removeChild(e.getCanvas())})}createOpacitySlider(e,t,i){let a=document.createElement("br"),s=document.createElement("div"),r=document.createElement("p"),n=document.createElement("input"),o=document.createTextNode("Opacity");a.setAttribute("id","opacity-br-"+e.layerId),s.setAttribute("class","layer-tool"),s.setAttribute("id","layer-"+e.layerId+"-opacity-tool"),r.setAttribute("class","layer-tool-text"),r.setAttribute("id","layer-"+e.layerId+"-opacity-text"),n.setAttribute("class","layer-tool-slider"),n.setAttribute("id","layer-"+e.layerId+"-opacity-slider"),n.setAttribute("type","range"),n.setAttribute("max",50),n.setAttribute("min",0),n.setAttribute("value",50*e.getLayerOpacity()),n.setAttribute("draggable","false"),n.addEventListener("input",()=>{e.setLayerOpacity(n.value/50),e.isActivated()&&(e.getCanvas().style.opacity=e.getLayerOpacity())}),r.appendChild(o),s.appendChild(r),s.appendChild(n),t.insertBefore(s,i.nextSibling),t.insertBefore(a,i.nextSibling)}destroyOpacitySlider(e){let t=document.getElementById("layer-"+e.layerId+"-opacity-tool"),i=document.getElementById("opacity-br-"+e.layerId);t.parentElement.removeChild(t),i.parentElement.removeChild(i)}createBackground(){let e=document.createElement("div");e.setAttribute("id","background-view"),e.setAttribute("class","background-view");let t=this.pixelInstance.background,i=document.createElement("div"),a=document.createElement("div"),s=document.createElement("input"),r=document.createElement("div"),n=document.createElement("div");i.setAttribute("draggable","false"),i.setAttribute("class","layer-div"),i.setAttribute("value",t.layerId),i.setAttribute("id","layer-"+t.layerId+"-selector"),s.setAttribute("type","text"),s.setAttribute("readonly","true"),s.setAttribute("value",t.layerName),a.setAttribute("class","color-box"),a.setAttribute("style","background-color: "+t.colour.toHexString()+";"),r.setAttribute("class","unchecked-layer-settings"),r.setAttribute("id","layer-"+t.layerId+"-options"),this.pixelInstance.background.isActivated()?(n.setAttribute("class","layer-activated"),this.pixelInstance.background.getCanvas().style.opacity=1):(n.setAttribute("class","layer-deactivated"),this.pixelInstance.background.getCanvas().style.opacity=0),n.setAttribute("id","layer-"+t.layerId+"-activation"),a.addEventListener("click",()=>{t.displayColourOptions()}),n.addEventListener("click",()=>{t.toggleLayerActivation()}),r.onclick=(()=>{t.displayLayerOptions()}),i.appendChild(s),i.appendChild(r),i.appendChild(a),i.appendChild(n),e.appendChild(i),document.body.appendChild(e)}destroyLockedLayerSelectors(){let e=document.getElementById("background-view");e.parentNode.removeChild(e)}createLayersView(e){let t,i,a=!1,s=document.createElement("div");s.setAttribute("id","layers-view"),s.setAttribute("class","layers-view");let r=(e,s,r,n,o,l)=>{s.addEventListener("click",()=>{e.displayColourOptions()}),r.addEventListener("click",()=>{e.toggleLayerActivation()}),n.addEventListener("keypress",t=>{this.pixelInstance.editLayerName(t,n,l,!1,a,e)}),o.onclick=(()=>{e.displayLayerOptions()}),l.ondrag=(e=>{this.pixelInstance.dragging(e),a=!0}),l.ondragstart=(e=>{this.pixelInstance.dragStart(e)}),l.ondrop=(e=>{this.pixelInstance.drop(e,t,i),a=!1}),l.onmousedown=(()=>{t=l.getAttribute("index"),this.highlightLayerSelectorById(e.layerId)}),l.ondragover=(e=>{this.pixelInstance.allowDrop(e),i=l.getAttribute("index")})};for(var n=e.length-1;n>=0;n--){let t=e[n],i=document.createElement("div"),o=document.createElement("br"),l=document.createElement("div"),d=document.createElement("input"),c=document.createElement("div"),h=document.createElement("div");i.setAttribute("index",n),i.setAttribute("draggable","true"),i.setAttribute("class","layer-div"),i.setAttribute("value",t.layerId),i.setAttribute("id","layer-"+t.layerId+"-selector"),i.setAttribute("title","Hotkey: "+t.layerId),d.setAttribute("type","text"),d.setAttribute("readonly","true"),d.setAttribute("value",t.layerName),d.setAttribute("ondblclick","this.readOnly='';"),d.addEventListener("dblclick",e=>{this.pixelInstance.editLayerName(e,d,i,!1,a,t),d.onblur=(e=>{this.pixelInstance.editLayerName(e,d,i,!0,a,t)})}),l.setAttribute("class","color-box"),l.setAttribute("style","background-color: "+t.colour.toHexString()+";"),c.setAttribute("class","unchecked-layer-settings"),c.setAttribute("id","layer-"+t.layerId+"-options"),t.isActivated()?h.setAttribute("class","layer-activated"):h.setAttribute("class","layer-deactivated"),h.setAttribute("id","layer-"+t.layerId+"-activation"),t.layerId===this.pixelInstance.layers[this.pixelInstance.selectedLayerIndex].layerId&&i.classList.add("selected-layer"),r(t,l,h,d,c,i),i.appendChild(d),i.appendChild(c),i.appendChild(l),i.appendChild(h),s.appendChild(i),s.appendChild(o)}document.body.appendChild(s),this.createBackground(e)}destroyLayerSelectors(){let e=document.getElementById("layers-view");e.parentNode.removeChild(e)}highlightLayerSelectorById(e){let t=!1;if(this.pixelInstance.layers.forEach(i=>{i.layerId===e&&(t=!0)}),!t)throw new n.b("The layer you are trying to select does not exist.");this.pixelInstance.layers.forEach(t=>{if(t.layerId===e){let e=document.getElementById("layer-"+t.layerId+"-selector");e.hasAttribute("selected-layer")||e.classList.add("selected-layer"),this.pixelInstance.changeCurrentlySelectedLayerIndex(this.pixelInstance.layers.indexOf(t))}else{let e=document.getElementById("layer-"+t.layerId+"-selector");e.classList.contains("selected-layer")&&e.classList.remove("selected-layer")}})}createBrushSizeSelector(){let e=document.createElement("div");e.setAttribute("class","tool-settings"),e.setAttribute("id","brush-size");let t=document.createTextNode("Brush size:"),i=document.createElement("input");i.setAttribute("id","brush-size-selector"),i.setAttribute("type","range"),i.setAttribute("max",40),i.setAttribute("min",1),i.setAttribute("value",25),i.addEventListener("input",()=>{this.createBrushCursor()}),e.appendChild(t),e.appendChild(i),document.body.appendChild(e)}destroyBrushSizeSelector(){let e=document.getElementById("brush-size");null!==e&&e.parentNode.removeChild(e)}createUndoButton(){let e=document.createElement("button"),t=document.createTextNode("Undo");this.undo=(()=>{this.pixelInstance.undoAction()}),e.setAttribute("id","undo-button"),e.appendChild(t),e.addEventListener("click",this.undo),document.body.appendChild(e)}destroyUndoButton(){let e=document.getElementById("undo-button");e.parentNode.removeChild(e)}createRedoButton(){let e=document.createElement("button"),t=document.createTextNode("Redo");this.redo=(()=>{this.pixelInstance.redoAction()}),e.setAttribute("id","redo-button"),e.appendChild(t),e.addEventListener("click",this.redo),document.body.appendChild(e)}destroyRedoButton(){let e=document.getElementById("redo-button");e.parentNode.removeChild(e)}createDeleteLayerButton(){let e=document.createElement("button"),t=document.createTextNode("Delete selected layer");this.deleteLayer=(()=>{try{this.pixelInstance.deleteLayer()}catch(e){e instanceof n.a&&alert(e.message)}}),e.setAttribute("id","delete-layer-button"),e.appendChild(t),e.addEventListener("click",this.deleteLayer),document.body.appendChild(e)}destroyDeleteLayerButton(){let e=document.getElementById("delete-layer-button");e.parentNode.removeChild(e)}createCreateLayerButton(){let e=document.createElement("button"),t=document.createTextNode("Create new layer");this.createLayer=(()=>{this.pixelInstance.createLayer()}),e.setAttribute("id","create-layer-button"),e.appendChild(t),e.addEventListener("click",this.createLayer),document.body.appendChild(e)}destroyCreateLayerButton(){let e=document.getElementById("create-layer-button");e.parentNode.removeChild(e)}createExportButtons(){let e=document.createElement("button"),t=document.createTextNode("Export as CSV"),i=document.createElement("button"),a=document.createTextNode("Export as PNG"),s=document.createElement("button"),r=document.createTextNode("Export as image Data PNG");this.exportCSV=(()=>{this.pixelInstance.exportAsCSV()}),this.exportPNG=(()=>{this.pixelInstance.exportAsPNG()}),this.exportPNGData=(()=>{this.pixelInstance.exportAsImageData()}),e.setAttribute("id","csv-export-button"),e.appendChild(t),e.addEventListener("click",this.exportCSV),i.setAttribute("id","png-export-button"),i.appendChild(a),i.addEventListener("click",this.exportPNG),s.setAttribute("id","png-export-data-button"),s.appendChild(r),s.addEventListener("click",this.exportPNGData),document.body.appendChild(e),document.body.appendChild(i),document.body.appendChild(s)}destroyExportButtons(){let e=document.getElementById("csv-export-button"),t=document.getElementById("png-export-button"),i=document.getElementById("png-export-data-button");e.parentNode.removeChild(e),t.parentNode.removeChild(t),i.parentNode.removeChild(i)}createImportButtons(){let e=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("id","imageLoader"),e.setAttribute("name","imageLoader"),this.import=(e=>{this.pixelInstance.importPNGToLayer(e)}),e.addEventListener("change",this.import,!1),document.body.appendChild(e)}destroyImportButtons(){let e=document.getElementById("imageLoader");e.parentNode.removeChild(e)}createInstructionButtons(){let e=document.createElement("button"),t=document.createTextNode("How to use"),i=document.createElement("button"),a=document.createTextNode("Keyboard shortcuts"),n=document.createElement("br");n.setAttribute("id","instruction-br"),e.setAttribute("id","tutorial-button"),e.appendChild(t),i.setAttribute("id","glossary-button"),i.appendChild(a),this.createTut=(()=>{new s.a}),this.createGlossary=(()=>{new r.a}),e.addEventListener("click",this.createTut),i.addEventListener("click",this.createGlossary),document.body.appendChild(n),document.body.appendChild(e),document.body.appendChild(i)}destroyInstructionButtons(){let e=document.getElementById("tutorial-button"),t=document.getElementById("glossary-button"),i=document.getElementById("instruction-br");i.parentNode.removeChild(i),e.parentNode.removeChild(e),t.parentNode.removeChild(t)}updateProgress(e){let t=e+"%",i="width: "+t;document.getElementById("pbar-inner-div").setAttribute("style",i),document.getElementById("pbar-inner-text").innerHTML=t}destroyBackground(e){this.pixelInstance.destroyLockedLayerSelectors(e)}createExportElements(e){let t=document.createElement("div"),i=document.createTextNode("Exporting"),a=document.createTextNode("0%"),s=document.createElement("div"),r=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),l=document.createElement("div"),d=document.createTextNode("Cancel");return t.setAttribute("class","export-div"),t.setAttribute("id","pixel-export-div"),s.setAttribute("class","pbar-outer-div"),s.setAttribute("id","pbar-outer-div"),r.setAttribute("class","pbar-inner-div"),r.setAttribute("id","pbar-inner-div"),n.setAttribute("class","pbar-inner-text"),n.setAttribute("id","pbar-inner-text"),o.setAttribute("class","pbar-export-text"),o.setAttribute("id","pbar-export-text"),l.setAttribute("class","cancel-export-div"),l.setAttribute("id","cancel-export-div"),l.addEventListener("click",()=>{l.setAttribute("style","background-color: #AAAAAA;"),e.exportInterrupted=!0}),o.appendChild(i),l.appendChild(d),n.appendChild(a),s.appendChild(r),s.appendChild(n),s.appendChild(o),s.appendChild(l),t.appendChild(s),document.body.appendChild(t),{progressCanvas:this.createProgressCanvas(e.pageIndex,e.zoomLevel)}}destroyExportElements(){let e=document.getElementById("pixel-export-div");e.parentNode.removeChild(e)}destroyDownloadLinks(){let e=document.getElementsByClassName("export-download");for(;e[0];)e[0].parentNode.removeChild(e[0])}createProgressCanvas(e,t){let i=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(e,t).height,a=this.pixelInstance.core.publicInstance.getPageDimensionsAtZoomLevel(e,t).width,s=document.createElement("canvas");s.setAttribute("id","progress-canvas"),s.style.opacity=.3,s.width=a,s.height=i,s.globalAlpha=1;let r=window,n=document,o=n.documentElement,l=n.getElementsByTagName("body")[0],d=r.innerHeight||o.clientHeight||l.clientHeight;return s.style.height=d+"px",document.getElementById("pixel-export-div").appendChild(s),s}markToolSelected(e){document.getElementById(e).checked=!0}getBrushSizeSelectorValue(){let e=document.getElementById("brush-size-selector"),t=e.value/e.max*10;return.05+Math.exp(t-6)}createBrushCursor(){let e=document.getElementById("brush-cursor-div"),t=document.getElementById("diva-1-viewport"),i=document.getElementById("diva-1-outer");null===e&&((e=document.createElement("div")).setAttribute("id","brush-cursor-div"),i.insertBefore(e,t)),e.setAttribute("oncontextmenu","return false"),this.resizeBrushCursor()}resizeBrushCursor(){let e=document.getElementById("brush-cursor-div");if(null===e)return;let t=Math.pow(2,this.pixelInstance.core.getSettings().zoomLevel),i=this.getBrushSizeSelectorValue()*t;e.style.width=i+"px",e.style.height=i+"px"}destroyBrushCursor(){let e=document.getElementById("brush-cursor-div");null!==e&&e.parentNode.removeChild(e)}moveBrushCursor(e){let t=document.getElementById("brush-cursor-div"),i=Math.pow(2,this.pixelInstance.core.getSettings().zoomLevel),a=this.getBrushSizeSelectorValue()*i;t.style.left=e.x-a/2-1+"px",t.style.top=e.y-a/2-1+"px"}restoreDefaultCursor(){document.getElementById("diva-1-outer").style.cursor="default"}setMousePosition(e){this.mouse.x=e.x-1,this.mouse.y=e.y-1}createRectanglePreview(e,t){this.setMousePosition(e);let i=document.getElementById("diva-1-viewport"),a=document.getElementById("diva-1-outer");this.mouse.startX=this.mouse.x,this.mouse.startY=this.mouse.y;let s=document.createElement("div");s.className="rectangle",s.id="preview-rectangle",s.style.left=this.mouse.x+"px",s.style.top=this.mouse.y+"px",s.style.border="1px solid "+t.colour.toHexString(),a.insertBefore(s,i)}resizeRectanglePreview(e,t){this.setMousePosition(e);let i=document.getElementById("preview-rectangle");null!==i&&(i.style.border="1px solid "+t.colour.toHexString(),i.style.width=Math.abs(this.mouse.x-this.mouse.startX)+"px",i.style.height=Math.abs(this.mouse.y-this.mouse.startY)+"px",i.style.left=this.mouse.x-this.mouse.startX<0?this.mouse.x+"px":this.mouse.startX+"px",i.style.top=this.mouse.y-this.mouse.startY<0?this.mouse.y+"px":this.mouse.startY+"px")}removeRectanglePreview(){let e=document.getElementById("preview-rectangle");null!==e&&e.parentNode.removeChild(e)}isInPageBounds(e,t){let i=this.pixelInstance.core.getSettings().activePageIndex,s=this.pixelInstance.core.getSettings().zoomLevel,r=this.pixelInstance.core.getSettings().renderer,n=this.pixelInstance.core.publicInstance.getCurrentPageDimensionsAtCurrentZoomLevel(),o=(new a.a).getCoordsInViewport(s,i,r),l=n.width+o.x,d=n.height+o.y,c=(new a.a).getRelativeCoordinatesFromPadded(i,r,l,d,s);return!(e<0||t<0||e>c.x||t>c.y)}tutorial(){let e=document.createElement("div");e.setAttribute("id","tutorial-div");let t=document.createElement("div");t.setAttribute("id","tutorial-overlay");let i=document.createElement("div");i.setAttribute("id","myModal"),i.setAttribute("class","modal");let a=document.createElement("div");a.setAttribute("class","modal-content");let s=document.createElement("div");s.setAttribute("class","modal-header");let r=document.createTextNode("Hello, World"),n=document.createElement("h2");n.appendChild(r);let o=document.createElement("span");o.setAttribute("class","close"),o.innerHTML="&times;";let l=document.createElement("div");l.setAttribute("class","modal-body");let d=document.createElement("p");d.innerHTML="The following is a glossary of the hotkeys you will find useful when using Pixel.js";let c=document.createElement("ul");c.setAttribute("style","list-style-type:none;");let h=document.createElement("li");h.innerHTML="<kbd>1</kbd> ... <kbd>9</kbd> layer select";let u=document.createElement("li");u.innerHTML="<kbd>b</kbd> brush tool";let g=document.createElement("li");g.innerHTML="<kbd>r</kbd> rectangle tool";let p=document.createElement("li");p.innerHTML="<kbd>g</kbd> grab tool";let m=document.createElement("li");m.innerHTML="<kbd>e</kbd> eraser tool";let y=document.createElement("li");y.innerHTML="<kbd>Shift</kbd>  force tools to paint in an exact way.";let b=document.createElement("li");b.innerHTML="<kbd>cmd</kbd> + <kbd>z</kbd> undo";let v=document.createElement("li");v.innerHTML="<kbd>cmd</kbd> + <kbd>Shift</kbd> + <kbd>z</kbd> redo";let x=document.createElement("div");x.setAttribute("class","modal-footer");let C=document.createElement("h2");C.innerHTML="Got It!",c.appendChild(h),c.appendChild(u),c.appendChild(g),c.appendChild(p),c.appendChild(m),c.appendChild(y),c.appendChild(b),c.appendChild(v),i.appendChild(a),a.appendChild(s),a.appendChild(l),a.appendChild(x),s.appendChild(n),s.appendChild(o),l.appendChild(d),l.appendChild(c),x.appendChild(C),e.appendChild(t),e.appendChild(i),document.body.appendChild(e),i.style.display="block",x.addEventListener("click",()=>{e.parentNode.removeChild(e)})}}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e){this.pixelInstance=e,this.type={brush:"brush",rectangle:"rectangle",grab:"grab",erase:"erase",select:"select"},this.currentTool=this.type.brush}getAllTools(){let e=[];for(let t in this.type)e.push(t);return e}setCurrentTool(e){switch(this.currentTool){case this.type.grab:this.pixelInstance.disableDragScrollable();break;case this.type.brush:case this.type.erase:case this.type.rectangle:this.pixelInstance.uiManager.destroyBrushCursor()}this.currentTool=e,this.pixelInstance.uiManager.markToolSelected(e);let t=document.getElementById("diva-1-outer"),i=document.getElementById("brush-size");switch(null===i&&(this.pixelInstance.uiManager.createBrushSizeSelector(),i=document.getElementById("brush-size")),e){case this.type.grab:this.pixelInstance.enableDragScrollable(),i.style.visibility="hidden",t.style.cursor="-webkit-grab";break;case this.type.rectangle:i.style.visibility="hidden",t.style.cursor="crosshair";break;case this.type.brush:case this.type.erase:i.style.visibility="visible",this.pixelInstance.uiManager.createBrushCursor(),t.style.cursor="none";break;case this.type.select:i.style.visibility="hidden",t.style.cursor="crosshair";break;default:t.style.cursor="default"}}getCurrentTool(){return this.currentTool}}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(e,t,i,a,s){this.pixelInstance=e,this.layers=t,this.exportInterrupted=!1,this.pageIndex=i,this.zoomLevel=a,this.matrix=null,this.uiManager=s}uploadLocalImageToLayer(e,t){let i=new FileReader;i.onload=(t=>{this.importFromImageURLToLayer(e,t.target.result)}),i.readAsDataURL(t.target.files[0])}importFromImageURLToLayer(e,t){let i=document.createElement("canvas");i.width=e.getCanvas().width,i.height=e.getCanvas().height;let a=i.getContext("2d"),s=new Image;s.src=t,s.onload=(()=>{a.drawImage(s,0,0);let t=a.getImageData(0,0,e.getCanvas().width,e.getCanvas().height),r=t.data;for(let t=0;t<r.length;t+=4)r[t]=e.colour.red,r[t+1]=e.colour.green,r[t+2]=e.colour.blue;a.putImageData(t,0,0),e.setBackgroundImageCanvas(i),e.drawLayer(this.pixelInstance.core.getSettings().maxZoomLevel,e.getCanvas())})}}},function(e,t,i){"use strict";i.d(t,"a",function(){return a});class a{constructor(){this.layer=null,this.selectedShape=null,this.type="selection",this.imageData=null}copyShape(e){this.layer.removeShapeFromLayer(this.selectedShape),this.layer.drawLayer(e,this.layer.getCanvas());let t=Math.pow(2,e),i=this.selectedShape.origin.relativeOriginX*t,a=this.selectedShape.origin.relativeOriginY*t,s=this.selectedShape.relativeRectWidth*t,r=this.selectedShape.relativeRectHeight*t,n=Math.min(i,i+s),o=Math.min(a,a+r),l=this.layer.getCanvas().getContext("2d").getImageData(n,o,Math.abs(s),Math.abs(r));this.imageData=l,this.selectedShape.changeBlendModeTo("add")}cutShape(e){this.layer.removeShapeFromLayer(this.selectedShape),this.layer.drawLayer(e,this.layer.getCanvas());let t=Math.pow(2,e),i=this.selectedShape.origin.relativeOriginX*t,a=this.selectedShape.origin.relativeOriginY*t,s=this.selectedShape.relativeRectWidth*t,r=this.selectedShape.relativeRectHeight*t,n=Math.min(i,i+s),o=Math.min(a,a+r),l=this.layer.getCanvas().getContext("2d").getImageData(n,o,Math.abs(s),Math.abs(r));this.imageData=l,this.selectedShape.changeBlendModeTo("subtract"),this.layer.addShapeToLayer(this.selectedShape),this.layer.drawLayer(e,this.layer.getCanvas())}pasteShapeToLayer(e){let t=this.imageData.data;for(let i=0;i<t.length;i+=4)t[i]=e.colour.red,t[i+1]=e.colour.green,t[i+2]=e.colour.blue;e.addToPastedRegions(this)}setSelectedShape(e,t){this.selectedShape=e,this.layer=t}clearSelection(e){null!==this.layer&&null!==this.selectedShape&&("select"===this.selectedShape.blendMode&&this.layer.removeShapeFromLayer(this.selectedShape),this.layer.drawLayer(e,this.layer.getCanvas()))}drawOnPage(e,t,i,a,s){let r=Math.pow(2,i),n=this.selectedShape.origin.relativeOriginX*r,o=this.selectedShape.origin.relativeOriginY*r,l=this.selectedShape.relativeRectWidth*r,d=this.selectedShape.relativeRectHeight*r,c=Math.min(n,n+l),h=Math.min(o,o+d),u=document.createElement("canvas");u.width=Math.abs(l),u.height=Math.abs(d),u.getContext("2d").putImageData(this.imageData,0,0),s.getContext("2d").drawImage(u,c,h)}}},,function(e,t,i){"use strict";i.r(t),function(e){i.d(t,"default",function(){return m});var a=i(0),s=i(7),r=i(6),n=i(1),o=i(5),l=i(8),d=i(9),c=i(10),h=i(11),u=i(3),g=i(4),p=i(2);class m{constructor(e){this.core=e,this.activated=!1,this.pageToolsIcon=this.createIcon(),this.scrollEventHandle=null,this.zoomEventHandle=null,this.mouseHandles=null,this.keyboardHandles=null,this.background=null,this.layers=null,this.mousePressed=!1,this.rightMousePressed=!1,this.selectedLayerIndex=0,this.layerChangedMidDraw=!1,this.actions=[],this.undoneActions=[],this.shiftDown=!1,this.initialShiftPress=!0,this.lastRelCoordX=null,this.lastRelCoordY=null,this.uiManager=null,this.tools=null,this.selection=null,this.horizontalMove=!1,this.layerIdCounter=2,this.editingLayerName=!1}handleClick(){this.activated?this.deactivatePlugin():this.activatePlugin()}activatePlugin(){if(null===this.layers){let e=new r.a(0,new n.a(242,242,242,1),"Background",this,1),t=new r.a(1,new n.a(51,102,255,1),"Layer 1",this,.5);this.layers=[t],this.background=e,this.background.canvas=this.core.getSettings().renderer._canvas}null===this.uiManager&&(this.uiManager=new l.a(this)),null===this.tools&&(this.tools=new d.a(this)),this.uiManager.createPluginElements(this.layers),this.scrollEventHandle=this.subscribeToScrollEvent(),this.zoomEventHandle=this.subscribeToZoomLevelWillChangeEvent(),this.disableDragScrollable(),this.subscribeToWindowResizeEvent(),this.subscribeToMouseEvents(),this.subscribeToKeyboardEvents(),this.tools.setCurrentTool(this.tools.getCurrentTool()),this.activated=!0,new u.a}deactivatePlugin(){e.Diva.Events.unsubscribe(this.scrollEventHandle),e.Diva.Events.unsubscribe(this.zoomEventHandle),this.unsubscribeFromMouseEvents(),this.unsubscribeFromKeyboardEvents(),this.redrawAllLayers(),this.uiManager.destroyPluginElements(this.layers,this.background),this.enableDragScrollable(),this.activated=!1}enableDragScrollable(){this.core.viewerState.viewportObject.hasAttribute("nochilddrag")&&this.core.viewerState.viewportObject.removeAttribute("nochilddrag")}disableDragScrollable(){this.core.viewerState.viewportObject.hasAttribute("nochilddrag")||this.core.viewerState.viewportObject.setAttribute("nochilddrag","")}createIcon(){const e=document.createElement("div");e.classList.add("diva-pixel-icon");let t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("x","0px"),t.setAttribute("y","0px"),t.setAttribute("viewBox","0 0 25 25"),t.id=`${this.core.settings.selector}pixel-icon`;let i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id=`${this.core.settings.selector}pixel-icon-glyph`,i.setAttribute("transform","matrix(1, 0, 0, 1, -11.5, -11.5)"),i.setAttribute("class","diva-pagetool-icon");let a=document.createElementNS("http://www.w3.org/2000/svg","rect");return a.setAttribute("x","15"),a.setAttribute("y","10"),a.setAttribute("width","25"),a.setAttribute("height","25"),i.appendChild(a),t.appendChild(i),e.appendChild(t),e}subscribeToWindowResizeEvent(){window.addEventListener("resize",()=>{this.layers.forEach(e=>{e.placeLayerCanvasOnTopOfEditingPage()})})}subscribeToZoomLevelWillChangeEvent(){return e.Diva.Events.subscribe("ZoomLevelWillChange",e=>{this.layers.forEach(t=>{t.resizeLayerCanvasToZoomLevel(e)})})}subscribeToScrollEvent(){return e.Diva.Events.subscribe("ViewerDidScroll",()=>{this.layers.forEach(e=>{e.placeLayerCanvasOnTopOfEditingPage()})})}subscribeToMouseEvents(){let e=document.getElementById("diva-1-outer");this.uiManager.createBrushCursor(),this.mouseDown=(e=>{this.onMouseDown(e)}),this.mouseUp=(e=>{this.onMouseUp(e)}),this.mouseMove=(e=>{this.onMouseMove(e)}),e.addEventListener("mousedown",this.mouseDown),e.addEventListener("mouseup",this.mouseUp),e.addEventListener("mouseleave",this.mouseUp),e.addEventListener("mousemove",this.mouseMove),this.mouseHandles={mouseDownHandle:this.mouseDown,mouseMoveHandle:this.mouseMove,mouseUpHandle:this.mouseUp}}subscribeToKeyboardEvents(){this.handleKeyUp=(e=>{this.onKeyUp(e)}),this.handleKeyDown=(e=>{this.onKeyDown(e)}),document.addEventListener("keyup",this.handleKeyUp),document.addEventListener("keydown",this.handleKeyDown),this.keyboardHandles={keyup:this.handleKeyUp,keydown:this.handleKeyDown}}unsubscribeFromMouseEvents(){let e=document.getElementById("diva-1-outer");e.removeEventListener("mousedown",this.mouseHandles.mouseDownHandle),e.removeEventListener("mouseup",this.mouseHandles.mouseUpHandle),e.removeEventListener("mouseleave",this.mouseHandles.mouseUpHandle),e.removeEventListener("mousemove",this.mouseHandles.mouseMoveHandle)}unsubscribeFromKeyboardEvents(){document.removeEventListener("keyup",this.keyboardHandles.keyup),document.removeEventListener("keydown",this.keyboardHandles.keydown)}dragStart(e){e.dataTransfer.setData("Text",e.target.id)}dragging(){}allowDrop(e){e.preventDefault()}drop(e,t,i){e.preventDefault(),this.reorderLayers(t,i)}reorderLayers(e,t){let i=this.layers[e];if(e>t){for(let i=1;i<=e-t;i++)this.layers[e-i+1]=this.layers[e-i];this.layers[t]=i}else if(e<t){for(let i=1;i<=t-e;i++)this.layers[e-1+i]=this.layers[parseFloat(e)+i];this.layers[t]=i}this.changeCurrentlySelectedLayerIndex(t),this.uiManager.destroyPluginElements(this.layers,this.background),this.uiManager.createPluginElements(this.layers),this.uiManager.destroyPixelCanvases(this.layers),this.uiManager.placeLayerCanvasesInDiva(this.layers),this.uiManager.placeLayerCanvasesInDiva(this.background),this.uiManager.highlightLayerSelectorById(this.layers[this.selectedLayerIndex].layerId),this.redrawAllLayers()}onKeyUp(e){let t=this.selectedLayerIndex,i=e.keyCode?e.keyCode:e.which;if(i>=49&&i<=57){try{this.uiManager.highlightLayerSelectorById(i-49+1)}catch(e){e instanceof p.b&&alert(e.message)}t!==this.selectedLayerIndex&&this.mousePressed&&(this.layerChangedMidDraw=!0)}switch(e.key.toLowerCase()){case"shift":this.shiftDown=!1;break;case"h":this.layers[this.selectedLayerIndex].toggleLayerActivation()}}onKeyDown(e){if(!this.editingLayerName)switch(e.key.toLowerCase()){case"[":console.log(this.selectedLayerIndex),0!==this.selectedLayerIndex&&this.reorderLayers(this.selectedLayerIndex,this.selectedLayerIndex-1);break;case"]":this.selectedLayerIndex!==this.layers.length-1&&this.reorderLayers(this.selectedLayerIndex,this.selectedLayerIndex+1);break;case"escape":null!==this.selection&&null===this.selection.imageData&&this.selection.clearSelection(this.core.getSettings().maxZoomLevel);break;case"backspace":try{(e.ctrlKey||e.metaKey)&&this.deleteLayer()}catch(e){e instanceof p.a&&alert(e.message)}break;case"n":(e.ctrlKey||e.metaKey)&&this.createLayer();break;case"z":(e.ctrlKey||e.metaKey)&&e.shiftKey?this.redoAction():(e.ctrlKey||e.metaKey)&&this.undoAction();break;case"c":(e.ctrlKey||e.metaKey)&&this.selection.copyShape(this.core.getSettings().maxZoomLevel);break;case"x":(e.ctrlKey||e.metaKey)&&this.selection.cutShape(this.core.getSettings().maxZoomLevel);break;case"v":(e.ctrlKey||e.metaKey)&&null!==this.selection&&null!==this.selection.imageData&&(this.selection.pasteShapeToLayer(this.layers[this.selectedLayerIndex]),this.selection=null,this.redrawLayer(this.layers[this.selectedLayerIndex]));break;case"shift":this.shiftDown=!0;break;case"f":this.core.publicInstance.toggleFullscreenMode();break;case"b":this.tools.setCurrentTool(this.tools.type.brush);break;case"r":this.tools.setCurrentTool(this.tools.type.rectangle);break;case"g":this.tools.setCurrentTool(this.tools.type.grab);break;case"e":this.tools.setCurrentTool(this.tools.type.erase);break;case"s":this.tools.setCurrentTool(this.tools.type.select);break;case"m":this.layers[this.selectedLayerIndex].toggleLayerActivation();break;case"h":this.layers[this.selectedLayerIndex].isActivated()&&this.layers[this.selectedLayerIndex].toggleLayerActivation();break;case"t":new u.a;break;case"k":new g.a}}editLayerName(e,t,i,a,s,r){this.editingLayerName=!0;i.removeAttribute("draggable"),i.setAttribute("draggable","false"),(13===(e.which||e.keyCode)||a)&&!1===s&&(this.editingLayerName=!1,r.updateLayerName(t.value),t.setAttribute("readonly","true"),i.setAttribute("draggable","true"))}getMousePos(e,t){let i=e.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}onMouseDown(e){let t=document.getElementById("diva-1-outer"),i=this.getMousePos(t,e);switch(null!==this.selection&&this.selection.clearSelection(this.core.getSettings().maxZoomLevel),1===e.which&&(this.rightMousePressed=!1),3===e.which&&(this.rightMousePressed=!0),this.mousePressed=!0,this.tools.getCurrentTool()){case this.tools.type.brush:this.rightMousePressed?this.initializeBrushSizeChange(i):this.initializeNewPathInCurrentLayer(i);break;case this.tools.type.rectangle:this.initializeRectanglePreview(i);break;case this.tools.type.grab:t.style.cursor="-webkit-grabbing";break;case this.tools.type.erase:this.rightMousePressed?this.initializeBrushSizeChange(i):this.initializeNewPathInCurrentLayer(i);break;case this.tools.type.select:this.selection=new h.a,this.initializeRectanglePreview(i)}this.undoneActions=[]}onMouseMove(e){let t=document.getElementById("diva-1-outer"),i=this.getMousePos(t,e);switch(this.tools.getCurrentTool()){case this.tools.type.brush:this.rightMousePressed?this.changeBrushSize(i):this.addPointToCurrentPath(i),this.uiManager.moveBrushCursor(i);break;case this.tools.type.rectangle:this.rectanglePreview(i);break;case this.tools.type.erase:this.rightMousePressed?this.changeBrushSize(i):this.addPointToCurrentPath(i),this.uiManager.moveBrushCursor(i);break;case this.tools.type.select:this.rectanglePreview(i)}}onMouseUp(){let e=document.getElementById("diva-1-outer");switch(this.mousePressed=!1,this.rightMousePressed=!1,this.horizontalMove=!1,this.initialShiftPress=!0,this.tools.getCurrentTool()){case this.tools.type.rectangle:break;case this.tools.type.grab:e.style.cursor="-webkit-grab"}}deleteLayer(){let e=this.layers.length;if("undefined"==typeof numberInputLayers){if(e<=1)throw new p.a("Must at least have one layer other than the background");this.uiManager.destroyPluginElements(this.layers,this.background),this.layers.splice(this.selectedLayerIndex,1),this.selectedLayerIndex=0,this.uiManager.createPluginElements(this.layers),this.redrawAllLayers()}}createLayer(){if("undefined"!=typeof numberInputLayers)return;let e;switch(this.layerIdCounter){case 1:e=new n.a(51,102,255,1);break;case 2:e=new n.a(2,136,0,1);break;case 3:e=new n.a(255,51,102,1);break;case 4:e=new n.a(255,221,0,1);break;case 5:e=new n.a(96,0,186,1);break;case 6:e=new n.a(239,143,0,1);break;case 7:e=new n.a(71,239,200,1);break;case 8:e=new n.a(247,96,229,1);break;case 9:e=new n.a(114,61,0,1);break;default:e=new n.a(parseInt(255*Math.random()),parseInt(255*Math.random()),parseInt(255*Math.random()),1)}let t=new r.a(this.layerIdCounter,e,"Layer "+this.layerIdCounter,this,.5);this.layerIdCounter++,this.layers.push(t),this.changeCurrentlySelectedLayerIndex(this.layers.length-1),this.uiManager.destroyPluginElements(this.layers,this.background),this.uiManager.createPluginElements(this.layers),this.redrawAllLayers()}redoAction(){if(this.undoneActions.length>0){let e=this.undoneActions[this.undoneActions.length-1];if(!e.layer.isActivated())return;switch(e.object.type){case"path":e.layer.addPathToLayer(e.object);break;case"shape":e.layer.addShapeToLayer(e.object);break;case"selection":e.layer.addToPastedRegions(e.object)}this.undoneActions.splice(this.undoneActions.length-1,1),this.redrawLayer(e.layer)}}undoAction(){if(this.actions.length>0){let e=this.actions[this.actions.length-1];if(!e.layer.isActivated())return;this.undoneActions.push(e),this.removeActionAtIndex(this.actions.length-1)}}removeActionAtIndex(e){if(this.actions.length>0&&this.actions.length>=e){let t=this.actions[e];this.removeAction(t)}}removeAction(e){if(null!==e){switch(e.object.type){case"path":e.layer.removePathFromLayer(e.object);break;case"shape":e.layer.removeShapeFromLayer(e.object);break;case"selection":e.layer.removeSelectionFromLayer(e.object)}this.redrawLayer(e.layer)}}initializeNewPathInCurrentLayer(e){if(!this.layers[this.selectedLayerIndex].isActivated())return;if(this.core.getSettings().activePageIndex!==this.layers[0].pageIndex)return;let t=this.core.getSettings().activePageIndex,i=this.core.getSettings().zoomLevel,s=this.core.getSettings().renderer,r=(new a.a).getRelativeCoordinatesFromPadded(t,s,e.x,e.y,i);if(this.uiManager.isInPageBounds(r.x,r.y)){let e=this.layers[this.selectedLayerIndex],s=new a.a(r.x,r.y,t),n=this.uiManager.getBrushSizeSelectorValue();this.lastRelCoordX=r.x,this.lastRelCoordY=r.y,this.tools.getCurrentTool()===this.tools.type.brush?(e.createNewPath(n,"add"),e.addToCurrentPath(s,"add")):this.tools.getCurrentTool()===this.tools.type.erase&&(e.createNewPath(n,"subtract"),e.addToCurrentPath(s,"subtract")),i=this.core.getSettings().maxZoomLevel,e.getCurrentPath().connectPoint(e,s,t,i,!1,this.core.getSettings().renderer,e.getCanvas(),"page")}else this.mousePressed=!1}addPointToCurrentPath(e){if(!this.layers[this.selectedLayerIndex].isActivated())return;if(this.core.getSettings().activePageIndex!==this.layers[0].pageIndex)return;if(!this.mousePressed)return;let t,i=this.core.getSettings().activePageIndex,s=this.core.getSettings().zoomLevel,r=this.core.getSettings().renderer,n=(new a.a).getRelativeCoordinatesFromPadded(i,r,e.x,e.y,s);if(this.uiManager.isInPageBounds(n.x,n.y))if(this.layerChangedMidDraw)this.initializeNewPathInCurrentLayer(e),this.layerChangedMidDraw=!1;else{let e=this.core.getSettings().activePageIndex,i=this.core.getSettings().maxZoomLevel;switch(this.mousePressed&&this.shiftDown?(this.initialShiftPress&&(Math.abs(n.x-this.lastRelCoordX)>=Math.abs(n.y-this.lastRelCoordY)&&(this.horizontalMove=!0),this.initialShiftPress=!1),t=this.horizontalMove?new a.a(n.x,this.lastRelCoordY,e):new a.a(this.lastRelCoordX,n.y,e)):(this.horizontalMove=!1,this.initialShiftPress=!0,this.lastRelCoordX=n.x,this.lastRelCoordY=n.y,t=new a.a(n.x,n.y,e)),this.tools.getCurrentTool()){case this.tools.type.brush:this.layers[this.selectedLayerIndex].addToCurrentPath(t,"add");break;case this.tools.type.erase:this.layers[this.selectedLayerIndex].addToCurrentPath(t,"subtract");break;default:this.layers[this.selectedLayerIndex].addToCurrentPath(t,"add")}let s=this.layers[this.selectedLayerIndex];s.getCurrentPath().connectPoint(s,t,e,i,!0,this.core.getSettings().renderer,s.getCanvas(),"page")}}initializeRectanglePreview(e){if(!this.layers[this.selectedLayerIndex].isActivated())return;if(this.core.getSettings().activePageIndex!==this.layers[0].pageIndex)return;let t=this.core.getSettings().activePageIndex,i=this.core.getSettings().zoomLevel,r=this.core.getSettings().renderer,n=(new a.a).getRelativeCoordinatesFromPadded(t,r,e.x,e.y,i);if(this.uiManager.isInPageBounds(n.x,n.y)){let e=this.layers[this.selectedLayerIndex];switch(this.tools.getCurrentTool()){case this.tools.type.select:e.addShapeToLayer(new s.a(new a.a(n.x,n.y,t),0,0,"select",this.tools.getCurrentTool())),this.selection.setSelectedShape(e.getCurrentShape(),this.layers[this.selectedLayerIndex]);break;case this.tools.type.rectangle:this.rightMousePressed?e.addShapeToLayer(new s.a(new a.a(n.x,n.y,t),0,0,"subtract",this.tools.getCurrentTool())):e.addShapeToLayer(new s.a(new a.a(n.x,n.y,t),0,0,"add",this.tools.getCurrentTool()))}this.redrawLayer(e)}}rectanglePreview(e){if(this.layers[this.selectedLayerIndex].isActivated()&&this.core.getSettings().activePageIndex===this.layers[0].pageIndex)if(this.layerChangedMidDraw)this.layerChangedMidDraw=!1,this.initializeRectanglePreview(e);else{if(!this.mousePressed)return;let t=this.core.getSettings().activePageIndex,i=this.core.getSettings().zoomLevel,s=this.core.getSettings().renderer,r=(new a.a).getRelativeCoordinatesFromPadded(t,s,e.x,e.y,i),n=this.layers[this.selectedLayerIndex].getCurrentShape();if(!this.uiManager.isInPageBounds(r.x,r.y))return;let o=n.relativeRectWidth;if(n.relativeRectWidth=r.x-n.origin.relativeOriginX,this.shiftDown){let e;e=this.isInMainDiagonal(r,n)?1:-1,this.uiManager.isInPageBounds(n.origin.relativeOriginX+n.relativeRectWidth,n.origin.relativeOriginY+e*n.relativeRectWidth)?n.relativeRectHeight=e*n.relativeRectWidth:n.relativeRectWidth=o}else n.relativeRectHeight=r.y-n.origin.relativeOriginY;this.redrawLayer(this.layers[this.selectedLayerIndex])}}initializeBrushSizeChange(e){let t=document.getElementById("brush-size-selector");this.prevMouseX=e.x,this.prevSize=t.value}changeBrushSize(e){let t=document.getElementById("brush-size-selector"),i=.1*(parseFloat(e.x)-parseFloat(this.prevMouseX));t.value=parseFloat(this.prevSize)+i,this.uiManager.resizeBrushCursor()}isInMainDiagonal(e,t){return e.x<t.origin.relativeOriginX&&e.y<t.origin.relativeOriginY||e.x>t.origin.relativeOriginX&&e.y>t.origin.relativeOriginY}redrawLayer(e){e.drawLayer(this.core.getSettings().maxZoomLevel,e.getCanvas())}redrawAllLayers(){this.layers.forEach(e=>{this.redrawLayer(e)})}changeCurrentlySelectedLayerIndex(e){this.selectedLayerIndex=e,null!==this.selection&&null===this.selection.imageData&&this.selection.clearSelection(this.core.getSettings().maxZoomLevel)}exportAsImageData(){let e=this.core.getSettings().activePageIndex,t=this.core.getSettings().zoomLevel;new o.a(this,this.layers,e,t,this.uiManager).exportLayersAsImageData()}exportAsPNG(){let e=this.core.getSettings().activePageIndex,t=this.core.getSettings().zoomLevel;new o.a(this,this.layers,e,t,this.uiManager).exportLayersAsPNG()}exportAsCSV(){let e=this.core.getSettings().activePageIndex,t=this.core.getSettings().maxZoomLevel;new o.a(this,this.layers,e,t,this.uiManager).exportLayersAsCSV()}importPNGToLayer(e){new c.a(this,this.layers,this.core.getSettings().activePageIndex,this.core.getSettings().zoomLevel,this.uiManager).uploadLocalImageToLayer(this.layers[this.selectedLayerIndex],e)}}m.prototype.pluginName="pixel",m.prototype.isPageTool=!0,window.Diva.PixelPlugin=m}.call(this,i(14))},function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(i=window)}e.exports=i}]);
//# sourceMappingURL=pixel.js.map